@model GestionPlazasVacantes.Models.Postulante
@{
    ViewData["Title"] = "Formulario de Postulación Interna";
    var plaza = ViewBag.Plaza as GestionPlazasVacantes.Models.PlazaVacante;
    Layout = "_Layout";
}



<div class="formulario-postulacion">
    <h4><i class="bi bi-person-badge me-2"></i>Formulario de Postulación</h4>
    <p class="subtitle text-center mb-4">Plaza: <strong>@plaza?.Titulo</strong></p>

    @if (TempData["ErrorMessage"] != null)
    {
        <div class="alert alert-danger text-center fw-semibold">
            <i class="bi bi-exclamation-triangle-fill me-2"></i>@TempData["ErrorMessage"]
        </div>
    }
    @if (TempData["SuccessMessage"] != null)
    {
        <div class="alert alert-success text-center fw-semibold">
            <i class="bi bi-check-circle-fill me-2"></i>@TempData["SuccessMessage"]
        </div>
    }

    <form id="formPostulacion" asp-action="Aplicar" method="post" enctype="multipart/form-data">
        <input type="hidden" asp-for="Id" />
        @Html.AntiForgeryToken()
        <div asp-validation-summary="All" class="text-danger mb-3"></div>
        <input type="hidden" asp-for="PlazaVacanteId" />

        <!-- 🔹 Datos personales -->
        <div class="seccion">
            <h5>1️⃣ Datos Personales</h5>
            <div class="row">
                <div class="col-md-6">
                    <label asp-for="NombreCompleto"></label>
                    <input asp-for="NombreCompleto" class="form-control" required />
                </div>
                <div class="col-md-6">
                    <label asp-for="Cedula"></label>
                    <input asp-for="Cedula" class="form-control" required />
                </div>
            </div>
            <div class="row mt-2">
                <div class="col-md-6">
                    <label asp-for="Correo"></label>
                    <input asp-for="Correo" type="email" class="form-control" required />
                </div>
                <div class="col-md-6">
                    <label asp-for="Telefono"></label>
                    <input asp-for="Telefono" class="form-control" />
                </div>
            </div>
            <div class="row mt-2">
                <div class="col-12">
                    <label asp-for="Direccion"></label>
                    <textarea asp-for="Direccion" class="form-control" rows="2"></textarea>
                </div>
            </div>
        </div>

        <!-- 🔹 Información Curricular -->
        <div class="seccion">
            <h5>📄 Información Curricular</h5>

            <label asp-for="PerfilProfesional"></label>
            <textarea asp-for="PerfilProfesional" class="form-control" rows="3" placeholder="Describe brevemente tu perfil profesional..."></textarea>

            <label asp-for="ExperienciaLaboral"></label>
            <textarea asp-for="ExperienciaLaboral" class="form-control" rows="3" placeholder="Describe tus experiencias laborales más relevantes..."></textarea>

            <label asp-for="FormacionAcademica"></label>
            <textarea asp-for="FormacionAcademica" class="form-control" rows="3" placeholder="Incluye tus títulos o grados académicos..."></textarea>

            <label asp-for="Habilidades"></label>
            <textarea asp-for="Habilidades" class="form-control" rows="2" placeholder="Ejemplo: liderazgo, programación, redacción técnica..."></textarea>

            <label asp-for="Idiomas"></label>
            <textarea asp-for="Idiomas" class="form-control" rows="2" placeholder="Ejemplo: Español (nativo), Inglés (B2)..."></textarea>

            <label asp-for="FormacionComplementaria"></label>
            <textarea asp-for="FormacionComplementaria" class="form-control" rows="2" placeholder="Cursos, certificaciones, talleres..."></textarea>

            <label asp-for="OtrosDatos"></label>
            <textarea asp-for="OtrosDatos" class="form-control" rows="2" placeholder="Cualquier otra información que consideres relevante..."></textarea>
        </div>

        <div class="seccion">
            <h5>📎 Currículum Vitae</h5>
            <p class="text-muted">Podés subir tu currículum en PDF o generarlo automáticamente con los datos del formulario.</p>

            <div class="row align-items-center">
                <div class="col-md-6">
                    <label for="curriculum" class="form-label">📄 Subir tu currículum (solo PDF)</label>
                    <input type="file" name="curriculum" id="curriculum" accept=".pdf" class="form-control" required />
                    <small class="text-muted">Tamaño máximo: 10 MB</small>
                </div>
                <div class="col-md-6 text-center">
                    <p class="mb-2"><strong>O bien</strong></p>
                    <button type="button" id="btnGenerarCV" class="btn btn-outline-primary">
                        <i class="bi bi-file-earmark-pdf"></i> Generar CV Automático
                    </button>
                    <small class="d-block text-muted mt-1">Se generará un PDF con los datos ingresados</small>
                </div>
            </div>
        </div>

        <!-- 🔹 Documentos requeridos -->
        @if (plaza != null && (plaza.SolicitarColegiatura || plaza.SolicitarLicencia || plaza.SolicitarPermisoArmas || plaza.SolicitarTitulos))
        {
            <div class="seccion mt-4">
                <h5>📚 Documentos Requeridos por la Plaza</h5>

                @if (plaza.SolicitarColegiatura)
                {
                    <label>Número de colegiatura @(plaza.ColegiaturaObligatoria ? "(Obligatorio)" : "(Opcional)")</label>
                    <input asp-for="NumeroColegiatura" class="form-control" required="@plaza.ColegiaturaObligatoria" />
                    <label class="mt-2">Foto del carné del colegio profesional</label>
                    <input type="file" name="FotoColegiatura" accept=".jpg,.jpeg,.png,.pdf" class="form-control" required="@plaza.ColegiaturaObligatoria" />
                }

                @if (plaza.SolicitarLicencia)
                {
                    <label class="mt-3">Tipo de licencia @(plaza.LicenciaObligatoria ? "(Obligatorio)" : "(Opcional)")</label>
                    <input asp-for="TipoLicencia" class="form-control" required="@plaza.LicenciaObligatoria" />
                    <label class="mt-2">Foto de la licencia</label>
                    <input type="file" name="FotoLicencia" accept=".jpg,.jpeg,.png,.pdf" class="form-control" required="@plaza.LicenciaObligatoria" />
                }

                @if (plaza.SolicitarPermisoArmas)
                {
                    <label class="mt-3">Número de permiso de portación de armas @(plaza.ArmasObligatorio ? "(Obligatorio)" : "(Opcional)")</label>
                    <input asp-for="NumeroPermisoArmas" class="form-control" required="@plaza.ArmasObligatorio" />
                    <label class="mt-2">Foto del permiso</label>
                    <input type="file" name="FotoPermisoArmas" accept=".jpg,.jpeg,.png,.pdf" class="form-control" required="@plaza.ArmasObligatorio" />
                }

                @if (plaza.SolicitarTitulos)
                {
                    <label class="mt-3">Adjuntar títulos o certificaciones @(plaza.TitulosObligatorios ? "(Obligatorio)" : "(Opcional)")</label>
                    <input type="file" name="ArchivoTitulos" multiple accept=".jpg,.jpeg,.png,.pdf" class="form-control" required="@plaza.TitulosObligatorios" />

                    <label class="mt-2">Foto del título principal</label>
                    <input type="file" name="FotoTitulo" accept=".jpg,.jpeg,.png,.pdf" class="form-control" required="@plaza.TitulosObligatorios" />
                }

            </div>
        }

        <!-- 🔹 Declaración bajo juramento -->
        <div class="seccion mt-4 declaracion">
            <h6 class="fw-bold mb-3"><i class="bi bi-shield-check"></i> Declaración bajo juramento</h6>
            <div class="form-check">
                <input class="form-check-input me-2" type="checkbox" id="declaracionJurada" required />
                <label class="form-check-label" for="declaracionJurada">
                    Declaro bajo juramento que la información brindada en este formulario y los documentos adjuntos es veraz,
                    completa y corresponde a mi persona. Entiendo que cualquier falsedad podrá ser motivo de
                    descalificación o anulación de mi postulación.
                </label>
            </div>
        </div>

        <!-- 🔘 Botones -->
        <div class="botones-formulario mt-4">
            
            <button type="submit" id="btnEnviar" class="btn btn-primary">
                <i class="bi bi-send-check"></i> Enviar Postulación
            </button>
        </div>
    </form>
</div>

<script>
    document.addEventListener("DOMContentLoaded", () => {
        const btnEnviar = document.getElementById("btnEnviar");
        const btnGenerarCV = document.getElementById("btnGenerarCV");

        // Validación del formulario principal
        btnEnviar.addEventListener("click", (e) => {
            const nombre = document.querySelector('[name="NombreCompleto"]').value.trim();
            const cedula = document.querySelector('[name="Cedula"]').value.trim();
            const correo = document.querySelector('[name="Correo"]').value.trim();
            const check = document.getElementById("declaracionJurada");

            if (!nombre || !cedula || !correo) {
                e.preventDefault();
                alert("⚠️ Por favor completa los campos obligatorios antes de enviar la postulación.");
                return false;
            }

            if (!check.checked) {
                e.preventDefault();
                alert("⚠️ Debes aceptar la declaración bajo juramento para continuar.");
                return false;
            }
        });

        // Generar CV en PDF
        btnGenerarCV.addEventListener("click", () => {
            const nombre = document.querySelector('[name="NombreCompleto"]').value.trim();
            const cedula = document.querySelector('[name="Cedula"]').value.trim();

            if (!nombre || !cedula) {
                alert("⚠️ Debes completar al menos tu nombre y cédula antes de generar el CV.");
                return;
            }

            // Crear formulario temporal para enviar datos a GenerarCVPrevia
            const form = document.createElement('form');
            form.method = 'POST';
            form.action = '@Url.Action("GenerarCVPrevia", "PlazasInternas")';
            form.target = '_blank';

            // Copiar todos los campos del formulario principal
            const campos = ['NombreCompleto', 'Cedula', 'Correo', 'Telefono', 'Direccion', 
                           'PerfilProfesional', 'ExperienciaLaboral', 'FormacionAcademica', 
                           'Habilidades', 'Idiomas', 'FormacionComplementaria', 'OtrosDatos'];

            campos.forEach(campo => {
                const input = document.querySelector(`[name="${campo}"]`);
                if (input && input.value) {
                    const hidden = document.createElement('input');
                    hidden.type = 'hidden';
                    hidden.name = campo;
                    hidden.value = input.value;
                    form.appendChild(hidden);
                }
            });

            // Agregar token antiforgery
            const token = document.querySelector('input[name="__RequestVerificationToken"]');
            if (token) {
                const hiddenToken = document.createElement('input');
                hiddenToken.type = 'hidden';
                hiddenToken.name = '__RequestVerificationToken';
                hiddenToken.value = token.value;
                form.appendChild(hiddenToken);
            }

            document.body.appendChild(form);
            form.submit();
            document.body.removeChild(form);
        });
    });
</script>
